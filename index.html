<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,viewport-fit=cover"
    />
    <title>50MB Video Recorder / Converter (MP4-first)</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico" />

    <link rel="stylesheet" href="main.css" />
    <link rel="stylesheet" href="map.css" />

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />

    <!-- ‚úÖ Leaflet.draw CSS (for path/marker editing) -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"
      crossorigin=""
    />
  </head>
  <body>
    <header id="appHeader">
      <div class="row">
        <h1>50MB Video Recorder / Converter</h1>
        <div class="row" style="gap: 8px">
          <button id="settingsBtn" class="btn" type="button">
            ‚öôÔ∏è Settings
          </button>
          <button id="themeBtn" class="btn" type="button">üåì Theme</button>
        </div>
      </div>

      <!-- Top-level tabs (Video / Map / Combo) -->
      <div class="topTabs" role="tablist" aria-label="app tabs">
        <button
          id="appTabVideo"
          class="btn topTab"
          type="button"
          role="tab"
          aria-selected="false"
        >
          üé• Video Only
        </button>
        <button
          id="appTabMap"
          class="btn topTab"
          type="button"
          role="tab"
          aria-selected="false"
        >
          üó∫Ô∏è Map / Plot
        </button>
        <button
          id="appTabCombo"
          class="btn topTab"
          type="button"
          role="tab"
          aria-selected="false"
        >
          üé•üó∫Ô∏è Video / Map
        </button>
      </div>
    </header>

    <main id="appMain">
      <!-- ========================= -->
      <!-- VIDEO TAB (existing UI)   -->
      <!-- ========================= -->
      <section id="videoTabPanel" class="card">
        <h2>
          <div class="tabs" role="tablist" aria-label="mode tabs">
            <button
              id="tabRecord"
              class="tab active"
              type="button"
              role="tab"
              aria-selected="true"
            >
              üé• Record
            </button>
            <button
              id="tabUpload"
              class="tab"
              type="button"
              role="tab"
              aria-selected="false"
            >
              üìÅ Upload
            </button>
          </div>
          <span class="pill"
            >Limit: <span class="mono" id="limitLabel">50.0 MB</span></span
          >
        </h2>

        <div class="content">
          <div id="secureBanner" class="banner" style="display: none">
            <div class="bannerTitle warn">iPhone camera needs HTTPS</div>
            <p>
              If you opened this from <span class="mono">Files</span> (file://),
              iPhone will usually block the camera. Host this page on HTTPS and
              open it in Safari.
            </p>
          </div>

          <div id="mp4Banner" class="banner" style="display: none">
            <div class="bannerTitle warn">MP4 encoding not supported here</div>
            <p>
              This browser/device can‚Äôt encode MP4 via MediaRecorder. Output
              will be WebM, which GorillaDesk won‚Äôt accept. Use iPhone Safari
              over HTTPS (often supports MP4), or use FFmpeg/server conversion.
            </p>
          </div>

          <!-- Concise camera enable group -->
          <div class="groupCard" id="cameraGroup">
            <div class="groupTop">
              <div class="groupTitle">Camera</div>
              <div class="groupSub mono" id="cameraStateLabel">Not enabled</div>
            </div>

            <div class="actions tight">
              <button id="enableCameraBtn" class="btn" type="button">
                üì∑ Enable
              </button>
              <button id="restartPreviewBtn" class="btn" type="button" disabled>
                üîÑ Restart
              </button>
            </div>

            <div class="note" style="margin-top: 8px">
              Tip: iPhone Safari requires HTTPS for camera access.
            </div>
          </div>

          <!-- Record Panel -->
          <div id="recordPanel" style="margin-top: 12px">
            <video id="preview" playsinline autoplay muted></video>

            <!-- Recording group -->
            <div class="groupCard" id="recordingGroup">
              <div class="groupTop">
                <div class="groupTitle">Recording</div>
                <div class="groupSub mono" id="recStateLabel">Idle</div>
              </div>

              <div class="status compact" aria-live="polite">
                <span class="pill"
                  >Size:
                  <span class="mono" id="recSizeLabel">0.0 MB</span></span
                >
                <span class="pill"
                  >Time: <span class="mono" id="recTimeLabel">0s</span></span
                >
                <span class="pill"
                  >Torch: <span class="mono" id="torchLabel">n/a</span></span
                >
                <span class="pill"
                  >Zoom: <span class="mono" id="zoomLabel">n/a</span></span
                >
              </div>

              <div
                class="bar"
                title="Recorded size vs 50MB (can exceed while recording)"
              >
                <div id="recBarFill"></div>
              </div>

              <div class="actions tight">
                <button id="recordToggleBtn" class="btn" type="button" disabled>
                  ‚è∫Ô∏è Record
                </button>
                <button id="pauseBtn" class="btn" type="button" disabled>
                  ‚è∏Ô∏è Pause
                </button>
                <button id="resetBtn" class="btn" type="button" disabled>
                  üßπ Reset
                </button>
              </div>

              <div class="note">
                Record as long as you want. After you stop, Convert can compress
                to ‚â§ 50MB.
              </div>
            </div>
          </div>

          <!-- Upload Panel -->
          <div id="uploadPanel" style="display: none; margin-top: 12px">
            <div class="groupCard">
              <div class="groupTop">
                <div class="groupTitle">Upload</div>
                <div class="groupSub mono">Pick a video file</div>
              </div>
              <label for="fileInput"
                >Choose a video (MP4/MOV recommended)</label
              >
              <input id="fileInput" type="file" accept="video/*" />
              <div class="note">
                Pick an existing video and convert it to ‚â§ 50MB.
              </div>
            </div>
          </div>

          <hr
            style="
              border: none;
              border-top: 1px solid var(--border);
              margin: 14px 0;
            "
          />

          <div class="status">
            <span class="pill"
              >Preferred output:
              <span class="mono" id="preferredMimeLabel">‚Äî</span></span
            >
            <span class="pill"
              >GorillaDesk compatible:
              <span class="mono" id="gdCompatLabel">‚Äî</span></span
            >
          </div>

          <!-- Convert group -->
          <div class="groupCard" id="convertGroup" style="margin-top: 12px">
            <div class="groupTop">
              <div class="groupTitle">Convert & Save</div>
              <div class="groupSub mono" id="convertStateLabel">Ready</div>
            </div>

            <div class="actions tight">
              <button id="convertBtn" class="btn" type="button" disabled>
                üß™ Convert ‚â§ 50MB
              </button>
              <button id="cancelConvertBtn" class="btn" type="button" disabled>
                ‚úã Cancel
              </button>
            </div>

            <div id="progressBox" class="progressBox">
              <div class="progressTop">
                <div>Attempt: <span class="mono" id="attemptText">‚Äî</span></div>
                <div>Status: <span class="mono" id="progressText">‚Äî</span></div>
              </div>

              <div class="status compact" style="margin-top: 8px">
                <span class="pill"
                  >Progress: <span class="mono" id="convPctLabel">‚Äî</span></span
                >
                <!-- <span class="pill"
                  >ETA: <span class="mono" id="convEtaLabel">‚Äî</span></span
                > -->
              </div>
              <div
                class="bar"
                title="Conversion progress for the current attempt"
                style="margin-top: 8px"
              >
                <div id="convBarFill"></div>
              </div>

              <div class="log mono" id="progressLog"></div>
            </div>

            <div id="resultArea" style="margin-top: 12px">
              <div class="note">
                Converted output will appear here with Save/Share.
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ========================= -->
      <!-- COMBO TAB (FULLSCREEN)    -->
      <!-- ========================= -->
      <section id="comboTabPanel" class="card" style="display: none">
        <h2>
          <span>Video + Plot</span>
          <span class="pill"
            >Record ‚Ä¢ Pause ‚Ä¢ Start/Stop path ‚Ä¢ Drop points</span
          >
        </h2>

        <div class="content comboContent">
          <div class="comboFullscreenStage" aria-label="combo fullscreen stage">
            <video id="comboPreview" playsinline muted autoplay></video>

            <div class="comboHud" aria-live="polite">
              <span class="pill mono" id="comboHudText">
                Camera: ‚Äî ‚Ä¢ Rec: ‚Äî ‚Ä¢ Points: 0 ‚Ä¢ Path: 0
              </span>
            </div>

            <div class="miniMapWrap" aria-label="minimap">
              <div id="minimap" class="miniMap"></div>
              <div class="miniReadout mono" id="miniReadout">
                GPS: ‚Äî ‚Ä¢ Points: 0 ‚Ä¢ Path: 0
              </div>
            </div>

            <div class="comboDock" aria-label="combo controls">
              <div class="comboDockInner">
                <div class="comboDockTopRow">
                  <div class="comboDockTitle">
                    <div class="mono" id="comboStateNote">Ready</div>
                  </div>
                  <div class="comboDockActions">
                    <button id="comboEnableCameraBtn" class="btn" type="button">
                      üì∑ Enable
                    </button>
                    <button
                      id="comboRecordToggleBtn"
                      class="btn"
                      type="button"
                      disabled
                    >
                      ‚è∫Ô∏è Record
                    </button>
                    <button
                      id="comboPauseBtn"
                      class="btn"
                      type="button"
                      disabled
                    >
                      ‚è∏Ô∏è Pause
                    </button>
                  </div>
                </div>

                <div class="comboDockBottomRow">
                  <button id="comboStartPathBtn" class="btn" type="button">
                    ‚ñ∂Ô∏è Start path
                  </button>
                  <button
                    id="comboDropPointBtn"
                    class="btn"
                    type="button"
                    disabled
                  >
                    üìç Drop point
                  </button>
                  <button
                    id="comboEditBtn"
                    class="btn"
                    type="button"
                    disabled
                    title="Edit points/path (only when path is stopped)"
                  >
                    ‚úèÔ∏è Edit
                  </button>
                  <!-- <button
                    id="comboCenterBtn"
                    class="btn"
                    type="button"
                    disabled
                  >
                    ‚óé Center
                  </button> -->
                  <button id="comboExitBtn" class="btn" type="button">
                    ‚¨ÖÔ∏è Back
                  </button>
                </div>

                <div class="comboDockHint note">
                  Tip: Start/stop the path. After you stop, tap Edit to move
                  points and tweak the path.
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ========================= -->
      <!-- MAP TAB                  -->
      <!-- ========================= -->
      <section id="mapTabPanel" class="card" style="display: none">
        <h2>
          <span>Map / Plot</span>
          <span class="pill">North-up ‚Ä¢ Satellite ‚Ä¢ GPS</span>
        </h2>

        <div class="content mapContent">
          <div id="mapBanner" class="banner" style="display: none">
            <div class="bannerTitle warn">Location permission required</div>
            <p>
              Enable location access to plot points and track your path. (Works
              best over HTTPS.)
            </p>
          </div>

          <div class="mapFrame">
            <div id="map" class="map"></div>

            <div class="mapControls" aria-label="map controls">
              <div>
                <button id="mapZoomInBtn" class="btn mapBtn" type="button">
                  Ôºã
                </button>
                <button id="mapZoomOutBtn" class="btn mapBtn" type="button">
                  Ôºç
                </button>
              </div>

              <div class="mapPad">
                <button id="mapPanUpBtn" class="btn mapBtn" type="button">
                  ‚Üë
                </button>
                <div class="mapPadMid">
                  <button id="mapPanLeftBtn" class="btn mapBtn" type="button">
                    ‚Üê
                  </button>
                  <button id="mapCenterBtn" class="btn mapBtn" type="button">
                    ‚óé
                  </button>
                  <button id="mapPanRightBtn" class="btn mapBtn" type="button">
                    ‚Üí
                  </button>
                </div>
                <button id="mapPanDownBtn" class="btn mapBtn" type="button">
                  ‚Üì
                </button>
              </div>
            </div>

            <div class="mapActionBar">
              <button id="startTrackBtn" class="btn" type="button">
                ‚ñ∂Ô∏è Start path
              </button>
              <button id="dropPointBtn" class="btn" type="button" disabled>
                üî¥ Drop point
              </button>

              <!-- ‚úÖ Edit / Done buttons -->
              <button
                id="editMapBtn"
                class="btn"
                type="button"
                disabled
                title="Edit points/path (only when path is stopped)"
              >
                ‚úèÔ∏è Edit
              </button>
              <button
                id="doneEditMapBtn"
                class="btn"
                type="button"
                style="display: none"
              >
                ‚úÖ Done
              </button>

              <button id="exportMapBtn" class="btn" type="button" disabled>
                üñºÔ∏è Export image
              </button>
              <button
                id="clearMapBtn"
                class="btn danger"
                type="button"
                disabled
              >
                üßΩ Clear
              </button>
            </div>

            <div class="mapReadout mono" id="mapReadout">
              GPS: ‚Äî ‚Ä¢ Points: 0 ‚Ä¢ Path: 0
            </div>

            <!-- ‚úÖ NEW: Edit Style Panel (shown only in edit mode by map.js) -->
            <div
              id="editStylePanel"
              class="editStylePanel"
              style="display: none"
            >
              <div class="editStyleTitle">Edit style</div>

              <div class="editStyleRow">
                <label for="dpSizeRange">Dot size</label>
                <input
                  id="dpSizeRange"
                  type="range"
                  min="16"
                  max="64"
                  step="1"
                  value="28"
                />
                <span class="mono" id="dpSizeLabel">28</span>
              </div>

              <div class="editStyleRow">
                <label for="dpFontRange">Number font</label>
                <input
                  id="dpFontRange"
                  type="range"
                  min="10"
                  max="36"
                  step="1"
                  value="14"
                />
                <span class="mono" id="dpFontLabel">14</span>
              </div>

              <div class="note" style="margin-top: 6px">
                Tip: In Edit mode, tap a red dot to change its number.
              </div>
            </div>
          </div>

          <div class="note">
            Tip: Start/stop the path. After you stop, use Edit to move points
            and adjust the blue line (drag handles).
          </div>

          <div id="mapExportArea" class="mapExportArea" style="display: none">
            <div class="groupCard">
              <div class="groupTop">
                <div class="groupTitle">Export</div>
                <div class="groupSub mono">Saved as an image</div>
              </div>
              <img id="mapExportImg" alt="Map export preview" />
              <div class="actions tight" style="margin-top: 10px">
                <a id="mapDownloadLink" class="btn" download="map-export.png"
                  >‚¨áÔ∏è Download</a
                >
              </div>
              <div class="note">
                If export is blank/gray, your tile provider may block canvas
                export. (Try HTTPS, or switch to a tile provider with CORS
                enabled.)
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- hidden helper elements -->
      <div class="hiddenTools">
        <canvas id="xCanvas"></canvas>
        <video id="xVideo" playsinline muted></video>
      </div>
    </main>

    <!-- Settings Sheet -->
    <div id="sheetOverlay" class="sheetOverlay"></div>
    <div
      id="sheet"
      class="sheet"
      aria-hidden="true"
      role="dialog"
      aria-modal="true"
    >
      <div class="sheetHeader">
        <h3>Settings</h3>
        <button id="closeSheetBtn" class="btn" type="button">‚úñÔ∏è Close</button>
      </div>
      <div class="sheetBody">
        <div class="twoCol">
          <div>
            <label for="cameraSelect">Camera</label>
            <select id="cameraSelect"></select>
          </div>
          <div>
            <label for="fpsSelect">FPS (record & convert)</label>
            <select id="fpsSelect">
              <option value="30" selected>30</option>
              <option value="24">24</option>
              <option value="20">20</option>
              <option value="15">15</option>
            </select>
          </div>
        </div>

        <div class="twoCol">
          <div>
            <label for="previewResSelect">Preview Resolution (camera)</label>
            <select id="previewResSelect">
              <option value="1280x720" selected>720p (1280√ó720)</option>
              <option value="854x480">480p (854√ó480)</option>
              <option value="640x360">360p (640√ó360)</option>
            </select>
          </div>
          <div>
            <label for="convertResSelect">Convert Max Resolution</label>
            <select id="convertResSelect">
              <option value="1280x720" selected>720p max</option>
              <option value="854x480">480p max</option>
              <option value="640x360">360p max</option>
              <option value="426x240">240p max</option>
            </select>
          </div>
        </div>

        <div>
          <label for="recordBitrate"
            >Recording bitrate (kbps):
            <span class="mono" id="recordBitrateLabel">1500</span></label
          >
          <input
            id="recordBitrate"
            type="range"
            min="250"
            max="8000"
            step="50"
            value="1500"
          />
          <div class="note">
            This affects raw recording size. Final size is controlled during
            conversion.
          </div>
        </div>

        <div>
          <label for="minQualitySelect"
            >Minimum quality floor (conversion)</label
          >
          <select id="minQualitySelect">
            <option value="640x360|250" selected>Min 360p @ 250 kbps</option>
            <option value="426x240|180">Min 240p @ 180 kbps</option>
            <option value="320x180|120">Min 180p @ 120 kbps</option>
          </select>
        </div>

        <div class="twoCol">
          <div>
            <label>Camera Controls</label>
            <button id="torchBtn" class="btn" type="button" disabled>
              üî¶ Torch: n/a
            </button>
            <div class="note">Torch works only on some rear cameras.</div>
          </div>
          <div>
            <label for="zoomRange"
              >Zoom: <span class="mono" id="zoomValue">n/a</span></label
            >
            <input
              id="zoomRange"
              type="range"
              min="1"
              max="1"
              step="0.1"
              value="1"
              disabled
            />
            <div class="note">Zoom depends on camera capabilities.</div>
          </div>
        </div>

        <div class="note">
          MP4 output requires MP4 encoding support from your browser
          (MediaRecorder). If unsupported, this app will fall back to WebM.
        </div>
      </div>
    </div>

    <!-- Preview Modal -->
    <div id="modalOverlay" class="modalOverlay" hidden></div>
    <div
      id="videoModal"
      class="modal"
      hidden
      inert
      role="dialog"
      aria-modal="true"
    >
      <div class="modalHeader">
        <h3>Preview</h3>
        <button id="closeModalBtn" class="btn" type="button">‚úñÔ∏è Close</button>
      </div>
      <div class="modalBody">
        <video id="modalVideo" controls playsinline></video>
        <div class="note" id="modalMetaNote"></div>
      </div>
    </div>

    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <!-- ‚úÖ Leaflet.draw JS -->
    <script
      src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"
      crossorigin=""
    ></script>

    <!-- Export helper -->
    <script
      src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"
      crossorigin="anonymous"
    ></script>

    <script src="./main.js"></script>
    <script src="./map.js"></script>
  </body>
</html>
